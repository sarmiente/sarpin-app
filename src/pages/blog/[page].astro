---
import Layout from "@/layouts/Layout.astro";
import Card from "@/components/Card.astro";
import { SITE_DESCRIPTION } from "../../../site.config";
import { getCollection } from "astro:content";
import SideBar from "@/sections//SideBar.astro";

// Obtener posts ordenados
const allPosts = (await getCollection("blog", (post) => !post.data.draft)).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Parámetro dinámico de la URL
const { page } = Astro.params;
const currentPage = Number(page) || 1;

// Configuración de paginación
const pageSize = 6; // ← cambia aquí cuántos posts por página
const totalPosts = allPosts.length;
const totalPages = Math.ceil(totalPosts / pageSize);

// Asegurar que la página existe
if (currentPage < 1 || currentPage > totalPages) {
  return Astro.redirect("/blog/");
}

// Cortar posts según la página actual
const start = (currentPage - 1) * pageSize;
const end = start + pageSize;
const posts = allPosts.slice(start, end);

// Generar categorías (igual que en index.astro)
const categories = Array.from(
  allPosts.reduce((map, post) => {
    const slug = post.data.category;
    const name = post.data.categoryName || slug;
    if (!map.has(slug)) {
      map.set(slug, { slug, name, count: 1 });
    } else {
      map.get(slug).count++;
    }
    return map;
  }, new Map()).values()
);
---

<Layout title="Noticias" description={SITE_DESCRIPTION}>
  <main class="bg-gradient-to-br from-main to-white">
    <section class="pt-24 pb-16">
      <div class="p-5 md:p-10">
        <h1
          class="text-3xl font-medium tracking-tight text-center text-white font-heading sm:text-4xl py-5"
        >
          Últimos Artículos
        </h1>
        <p
          class="text-2xl text-center font-body font-light tracking-tight text-white"
        >
          Explora nuestros ultimos articulos y mantente actualizado con las
          novedades.
        </p>
      </div>

      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3 lg:gap-8 p-5 md:p-10">
        <!-- Lista de Posts -->
        <div class="p-5 rounded bg-white lg:col-span-2">
          <ul
            class="grid gap-8 max-w-6xl mx-auto px-4 sm:grid-cols-2 lg:grid-cols-3"
          >
            {
              posts.map((post) => (
                <Card
                  title={post.data.title}
                  description={post.data.description}
                  author={post.data.author || "Autor Desconocido"}
                  category={post.data.categoryName || "Sin categoría"}
                  date={post.data.pubDate}
                  image={post.data.heroImage ?? ""}
                  href={`/blog/${post.id}/`}
                />
              ))
            }
          </ul>

          <!-- Paginación -->
          <nav class="flex justify-center mt-10 gap-2">
            {currentPage > 1 && (
              <a
                href={`/blog/${currentPage - 1}`}
                class="px-4 py-2 bg-main text-white rounded hover:bg-main/90"
              >
                ← Anterior
              </a>
            )}

            {Array.from({ length: totalPages }).map((_, i) => {
              const n = i + 1;
              return (
                <a
                  href={`/blog/${n}`}
                  class={`px-3 py-2 rounded border ${
                    n === currentPage
                      ? "bg-main text-white"
                      : "bg-white text-main hover:bg-gray-100"
                  }`}
                >
                  {n}
                </a>
              );
            })}

            {currentPage < totalPages && (
              <a
                href={`/blog/${currentPage + 1}`}
                class="px-4 py-2 bg-main text-white rounded hover:bg-main/90"
              >
                Siguiente →
              </a>
            )}
          </nav>
        </div>

        <!-- SIDEBAR Categorías -->
        <SideBar />
      </div>
    </section>
  </main>
</Layout>
